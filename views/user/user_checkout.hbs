<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Check Out</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/cart">Cart</a>
                        <span>Check Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->
<div class="d-flex" style="margin-left:200px;">
    {{#each address}}
    <div class="card d-inline-flex mt-5 shadow" style="width: 18rem; border-radius:10px">
    
        <div class="card-body">
            <h5 class="card-title">{{../user.name}}</h5>
            <h6 class="card-subtitle mb-2 text-muted">+91-{{../user.phone}}</h6>
            <p class="card-text">{{this.Address}},{{this.City}},{{this.State}},{{this.Country}},{{this.Pin}}</p>
            <a id="Use" style="font-color-white"
                onclick="checkOut_address('{{this.Address}}','{{this.City}}','{{this.State}}','{{this.Country}}','{{this.Pin}}','{{../user.name}}','{{../user.email}}','{{../user.phone}}')"
                class="btn btn-sm btn-dark">
                <h6 style="color: white;">Use</h6>
            </a>
        </div>
    
    </div>
    {{/each}}
    <div class="ml-auto " style="padding-right: 230px; ">
        {{#if coupons}}
        <h4 class="order__title mt-3" style="padding-top:30px; font-size:50px;">Your Coupons</h4>

        {{#each coupons}}
        <ul class="list-group mt-3 shadow" style="list-style-type: none;">
            <li>{{this.Name}} {{this.Discount}}%<span style="margin-left: 25px;"><button
                        onclick="applyCoupon('{{this._id}}','{{../user._id}}','{{../total}}')" class="text-white ml-5 mr-auto"
                        style="background-color:black; width:120px;">Apply</button></span></li>

        </ul>
        {{/each}}

        {{/if}}
    </div>
</div>

<!-- Checkout Section Begin -->
<section class="checkout spad ">
    <div class="container">
        <div class="checkout__form">
            <form action="" id="checkout_form">
                <div class="row">
                    <div class="col-lg-8 col-md-6">
                        <h6 class="coupon__code"><span class="icon_tag_alt"></span> Have a coupon? <a href="#">Click
                                here</a> to enter your code</h6>
                        <h6 class="checkout__title">Billing Details</h6>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Name<span>*</span></p>
                                    <input class="form-control" id="fname" name="fname" type="text">
                                </div>
                            </div>
                            {{!-- <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Last Name<span>*</span></p>
                                    <input class="form-control" id="lname" name="lname" type="text">
                                </div>
                            </div> --}}
                        </div>
                        <div class="checkout__input">
                            <p>Country<span>*</span></p>
                            <input class="form-control" id="country" name="country" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>Address<span>*</span></p>
                            <input class="form-control" id="address1" name="address1" type="text" placeholder="">

                        </div>
                        <div class="checkout__input">
                            <p>Town/City<span>*</span></p>
                            <input class="form-control" id="town_city" name="town_city" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>State<span>*</span></p>
                            <input class="form-control" id="state" name="state" type="text">
                        </div>
                        <div class="checkout__input">
                            <p>Pincode<span>*</span></p>
                            <input class="form-control" id="pin" name="pin" type="number">
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Phone<span>*</span></p>
                                    <input class="form-control" id="phone" name="phone" type="phone">
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Email<span>*</span></p>
                                    <input class="form-control" id="email" name="email" type="email">
                                </div>
                            </div>
                        </div>
                        <input type="text" name="userId" id="" value="{{user._id}}" hidden>

                    </div>
                    <div class="col-lg-4 col-md-6">

                        <div class="checkout__order">
                            <h4 class="order__title">Your order</h4>
                            <div class="checkout__order__products">Product <span>Quantity</span></div>
                            {{#each products}}
                            <ul class="checkout__total__products">
                                <li>{{this.product.Name}} <span>{{this.quantity}}</span></li>

                            </ul>
                            {{/each}}


                            <ul class="checkout__total__all">
                                <li>Subtotal <span>Rs.{{total}}</span></li>
                                <li>Discount Price <span id="discount">-</span></li>
                                <li>Total <span id="total">Rs.{{total}}</span></li>
                            </ul>

                            <div class="checkout__input__checkbox">
                                <label for="acc-or">
                                    Create an account?
                                    <input type="checkbox" id="acc-or">
                                    <span class="checkmark"></span>
                                </label>
                                ______________________________________
                            </div>

                            <div class="">
                                <label for="">

                                    <input type="radio" name="payment_method" value="COD">
                                    COD(Cash On Delivery)
                                </label>
                            </div>
                            <div class="">
                                <label for="">

                                    <input type="radio" name="payment_method" value="ONLINE">
                                    Online Payment
                                </label>
                            </div>
                            <button type="submit" class="site-btn">PLACE ORDER</button>
                        </div>

                    </div>
                </div>

            </form>

        </div>
    </div>
</section>
<!-- Checkout Section End -->

<!-- Footer Section Begin -->


<!-- Search Begin -->
<div class="search-model">
    <div class="h-100 d-flex align-items-center justify-content-center">
        <div class="search-close-switch">+</div>
        <form class="search-model-form">
            <input type="text" id="search-input" placeholder="Search here.....">
        </form>
    </div>
</div>
<!-- Search End -->

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


<script>
    $("#checkout_form").submit((e) => {
        e.preventDefault()
        $.ajax({
            url: '/place_order',
            method: 'post',
            data: $('#checkout_form').serialize(),
            success: (response) => {
                console.log("success----", response)
                if (response.cod_success) {
                    location.href = '/cod_success'
                } else {
                    razorpayPayment(response)
                }

            }
        })
    })

    function razorpayPayment(order) {
        var options = {
            "key": "rzp_test_C2SwUfxIkg9Jhn", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "A J",
            "description": "Test Transaction",
            "image": "/images/aj_logo2.jpg",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                //alert(response.razorpay_payment_id);
                //alert(response.razorpay_order_id);
                //alert(response.razorpay_signature);

                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Jishad aj",
                "email": "ajjishad0@gmail.com",
                "contact": "9791919284"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#05070B"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();

    }

    function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify_payment',
            data: {
                payment,
                order
            },
            method: 'post',
            success: (response) => {
                console.log(response)
                if (response.status) {
                    alert("payment success")
                    location.href = '/cod_success'
                } else {
                    alert("Payment Failed")
                }
            }
        })
    }

    function checkOut_address(a, b, c, d, e, f, g, h) {
        console.log(a, b, c, d, e, f, g, h)
        document.getElementById('Use').addEventListener('click', function () {
            Swal.fire("Address Added")
        })
        document.getElementById('fname').value = f;
        document.getElementById('country').value = d;
        document.getElementById('address1').value = a;
        document.getElementById('town_city').value = b;
        document.getElementById('state').value = c;
        document.getElementById('pin').value = e;
        document.getElementById('phone').value = '+91-' + h;
        document.getElementById('email').value = g;
    }

    function applyCoupon(couponId, userId, total) {
        console.log(couponId, userId, total)
        $.ajax({
            url: '/apply_coupon',
            data: {
                couponId,
                userId,
                total
            },
            method:'post',
            success: (response) =>{
                if(response.status){
                     swal({
                            position: 'center',
                            icon: 'success',
                            title: 'Coupon Success',
                            showConfirmButton: false,
                            timer: 2000
                        })
                    //alert('Coupon Success')
                    document.getElementById('discount').innerHTML = "Rs."+response.discountPrice
                    document.getElementById('total').innerHTML = "Rs."+response.discountTotal
                }else{
                    swal({
                            position: 'center',
                            icon: 'failed',
                            title: 'Invalid coupon 😔',
                            showConfirmButton: false,
                            timer: 2000
                        })
                }
            }
        })
    }

</script>